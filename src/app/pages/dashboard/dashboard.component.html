<div [@routeAnimation] class="card card--panel perm-wrapper">

  <!-- Debajo del header -->
  <section class="container-fluid mt-1 p-5">

    <!-- Banner: Hit Actual -->
    <div class="panel p-3 mb-3 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="avatar d-flex align-items-center justify-content-center">
          <mat-icon>directions_walk</mat-icon>
        </div>

        <div>
          <h3 class="title m-0">Hit Actual</h3>

          <div class="d-flex align-items-center flex-wrap gap-2 mt-2">
            <span class="chip d-inline-flex align-items-center gap-1">
              <mat-icon fontIcon="person" class="mat-18"></mat-icon> {{ hit.genero }}
            </span>
            <span class="chip d-inline-flex align-items-center gap-1">
              <mat-icon fontIcon="calendar_today" class="mat-18"></mat-icon> {{ hit.edad }} años
            </span>
            <span class="chip d-inline-flex align-items-center gap-1">
              <mat-icon fontIcon="sentiment_satisfied_alt" class="mat-18"></mat-icon> {{ hit.estado }}
            </span>
          </div>

          <div class="mt-2">
            <span class="badge bg-light text-ligth">ID Registro: {{ hit.id }}</span>
          </div>
        </div>
      </div>

      <div class="text-end">
        <span class="time-pill">{{ now | date:'dd-MMM-yyyy h:mm a' }}</span>
      </div>
    </div>

    <!-- Filtros -->
    <div class="row g-3 mt-5 align-items-end justify-content-end mb-3">
      <div class="col-auto">
        <label class="form-label mb-1">Fecha Inicio:</label>
        <dx-date-box [(value)]="fechaInicio" type="date" displayFormat="dd-MMM-yyyy"></dx-date-box>
      </div>

      <div class="col-auto">
        <label class="form-label mb-1">Fecha Fin:</label>
        <dx-date-box [(value)]="fechaFin" type="date" displayFormat="dd-MMM-yyyy"></dx-date-box>
      </div>

      <div class="col-auto">
        <button class="btn btn-primary" (click)="consultar()">Consultar</button>
      </div>
    </div>

    <!-- Tarjetas de gráficas -->
    <div class="row g-3">
      <!-- Conteo de Hits -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="box p-3 h-100">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="title">Conteo de Hits</div>
              <div class="subtitle">Personas: {{ totalPersonas }}</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary">
              <mat-icon fontIcon="menu" class="mat-18"></mat-icon>
            </button>
          </div>

          <dx-pie-chart [dataSource]="chartHits" type="doughnut" [innerRadius]="0.7" [legend]="{ visible: true }"
            [customizePoint]="customizePoint">
            <dxi-series argumentField="grupo" valueField="valor"></dxi-series>
            <dxo-tooltip [enabled]="true"></dxo-tooltip>
            <dxo-label [visible]="false"></dxo-label>
          </dx-pie-chart>

          <div class="d-flex justify-content-around mt-2 small">
            <div>Hombres</div>
            <div>Mujeres</div>
          </div>
        </div>
      </div>

      <!-- Edades Ambos Géneros -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="box p-3 h-100">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="title">Conteo de Edades Ambos Géneros</div>
              <div class="subtitle">Personas: {{ totalPersonas }}</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary">
              <mat-icon fontIcon="menu" class="mat-18"></mat-icon>
            </button>
          </div>

          <dx-pie-chart [dataSource]="chartEdadesAmbos" type="doughnut" [innerRadius]="0.7" [legend]="{ visible: true }"
            [customizePoint]="customizeEdadPoint" [tooltip]="{ enabled: true, customizeTooltip: customizeEdadTooltip }">
            <dxi-series argumentField="rango" valueField="valor"></dxi-series>
            <dxo-label [visible]="false"></dxo-label>
          </dx-pie-chart>

          <div class="d-flex justify-content-around mt-2 small">
            <div>0 - 20</div>
            <div>21 - 40</div>
            <div>41 - 60</div>
            <div>61+</div>
          </div>
        </div>
      </div>

      <!-- Segmentación por Edades - Mujeres -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="box p-3 h-100">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="title">Segmentación por Edades</div>
              <div class="subtitle">Mujeres: {{ totalMujeres }}</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary">
              <mat-icon fontIcon="menu" class="mat-18"></mat-icon>
            </button>
          </div>

          <dx-pie-chart [dataSource]="chartEdadesMujeres" type="doughnut" [innerRadius]="0.7"
            [legend]="{ visible: true }" [customizePoint]="customizeEdadMujeresPoint"
            [tooltip]="{ enabled: true, customizeTooltip: customizeEdadMujeresTooltip }">
            <dxi-series argumentField="rango" valueField="valor"></dxi-series>
            <dxo-label [visible]="false"></dxo-label>
          </dx-pie-chart>

          <div class="d-flex justify-content-around mt-2 small">
            <div>0 - 20</div>
            <div>21 - 40</div>
            <div>41 - 60</div>
            <div>61+</div>
          </div>
        </div>
      </div>

      <!-- Segmentación por Edades - Hombres -->
      <div class="col-12 col-md-6 col-xl-3">
        <div class="box p-3 h-100">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div>
              <div class="title">Segmentación por Edades</div>
              <div class="subtitle">Hombres: {{ totalHombres }}</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary">
              <mat-icon fontIcon="menu" class="mat-18"></mat-icon>
            </button>
          </div>

          <dx-pie-chart [dataSource]="chartEdadesHombres" type="doughnut" [innerRadius]="0.7"
            [legend]="{ visible: true }" [customizePoint]="customizeEdadHombresPoint">
            <dxi-series argumentField="rango" valueField="valor"></dxi-series>
            <dxo-tooltip [enabled]="true"></dxo-tooltip>
            <dxo-label [visible]="false"></dxo-label>
          </dx-pie-chart>

          <div class="d-flex justify-content-around mt-2 small">
            <div>0 - 20</div>
            <div>21 - 40</div>
            <div>41 - 60</div>
            <div>61+</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Barra apilada: Conteo de Hits por Hora -->
    <div class="row g-3 mt-3">
      <div class="col-12">
        <div class="box p-3">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="title">Conteo de Hits por Hora</div>
            <button class="btn btn-sm btn-outline-secondary">
              <mat-icon fontIcon="menu" class="mat-18"></mat-icon>
            </button>
          </div>

          <dx-chart [dataSource]="hitsPorHora" [customizePoint]="customizePoint">
            <dxo-common-series-settings argumentField="hora" type="stackedBar"></dxo-common-series-settings>

            <dxi-series valueField="hombres" name="Hombres"></dxi-series>
            <dxi-series valueField="mujeres" name="Mujeres"></dxi-series>

            <dxo-legend [visible]="true" position="outside" horizontalAlignment="center"></dxo-legend>
            <dxo-tooltip [enabled]="true"></dxo-tooltip>

            <dxo-argument-axis [grid]="{ visible: false }"></dxo-argument-axis>

            <dxo-label [visible]="true" [backgroundColor]="'transparent'"></dxo-label>
          </dx-chart>
        </div>
      </div>
    </div>

    <!-- Registro de Incidencias -->
    <div class="row g-3 mt-3">
      <div class="col-12">
        <div class="box p-3">
          <div class="title mb-2">Registro de Incidencias</div>

          <dx-data-grid [dataSource]="registros" [columnHidingEnabled]="true" [showBorders]="true"
            [showColumnLines]="true" [showRowLines]="true" [rowAlternationEnabled]="true" [height]="500">
            <dxo-group-panel [visible]="true"
              [emptyPanelText]="'Arrastre un encabezado de columna aquí para agrupar por esa columna'"></dxo-group-panel>

            <dxo-search-panel [visible]="true" [width]="260" [placeholder]="'Buscar...'"></dxo-search-panel>

            <dxo-filter-row [visible]="true"></dxo-filter-row>
            <dxo-header-filter [visible]="true"></dxo-header-filter>

            <dxo-paging [pageSize]="10"></dxo-paging>
            <dxo-pager [showPageSizeSelector]="true" [allowedPageSizes]="[10, 20, 50, 100, 200]" [showInfo]="true"
              [infoText]="'Page {0} of {1} ({2} items)'"></dxo-pager>

            <!-- Género -->
            <dxi-column alignment="center" dataField="genero" caption="Género" dataType="string" alignment="center"
              cellTemplate="gen"></dxi-column>

            <dxi-column alignment="center" dataField="edad" caption="Edad" dataType="number" [customizeText]="edadText"></dxi-column>

            <dxi-column alignment="center" dataField="estado" caption="Estado de Animo" dataType="string" alignment="center"
              cellTemplate="est"></dxi-column>

            <!-- Template para Género -->
            <div *dxTemplate="let f of 'gen'">
              <span class="badge genero" [ngClass]="(f.data?.genero === 'Hombre') ? 'hombre' : 'mujer'">
                {{ f.data?.genero }}
              </span>
            </div>

            <!-- Template para Estado de Ánimo -->
            <div *dxTemplate="let f of 'est'">
              <span class="badge estado" [ngClass]="{
      feliz:   f.data?.estado === 'Feliz',
      neutral: f.data?.estado === 'Neutral',
      triste:  f.data?.estado === 'Triste'
    }">
                {{ f.data?.estado }}
              </span>
            </div>


            <dxi-column alignment="center" dataField="fechaHora" caption="Fecha y Hora" dataType="date"
              [format]="'dd-MMM-yyyy h:mm a'"></dxi-column>

            <dxi-column alignment="center" dataField="id" caption="ID" dataType="number"></dxi-column>
          </dx-data-grid>

          <div class="mt-3 fw-bold text-success">Total: {{ totalPersonas }}</div>
        </div>
      </div>
    </div>


  </section>

</div>